<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Minecraft Resource Pack Combiner — OG Krish</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- JSZip via CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js" integrity="sha512-+gV0f0K3JXb4n0z3h9a7L5T0m36vJt+0rU8h3h4fuh8aTqj29k9H9rTzY+qKQm0e4JbR4I2xg8Vv1Gx3xJvEwg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <!-- FileSaver for download -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js" integrity="sha512-v2f1G6ZbU5Jm5j3hI5F3Dkm9pA9w9w8gW0hXkQ5Zp0g0H3lIY0b5n6yS5gW8jYVfFzT7o7O8z4H6Gd2pZr2a0w==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <style>
    :root {
      --bg: #0c0f10;
      --panel: #13181b;
      --muted: #c9d1d9;
      --accent: #00e676;
      --accent-dim: #00b85c;
      --border: #1f2529;
      --danger: #ff5252;
      --warn: #ffb300;
    }
    * { box-sizing: border-box }
    body {
      margin: 0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 800px at 80% -20%, #10231c 0%, #0c0f10 45%) no-repeat, var(--bg);
      color: var(--muted);
    }
    header {
      padding: 24px 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 14px;
    }
    .logo {
      width: 36px; height: 36px; border-radius: 8px; background: linear-gradient(135deg, #0f3 0%, #0a4 60%, #062 100%);
      box-shadow: 0 0 16px rgba(0, 230, 118, 0.35), inset 0 0 12px rgba(0, 230, 118, 0.3);
    }
    h1 { font-size: 20px; margin: 0; color: #e6fff0 }
    main { padding: 20px; max-width: 1200px; margin: 0 auto; display: grid; grid-template-columns: 1.1fr 0.9fr; gap: 20px }
    @media (max-width: 980px) { main { grid-template-columns: 1fr } }
    .card {
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.00));
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 16px;
      backdrop-filter: blur(6px);
    }
    .card h2 { margin: 0 0 10px 0; font-size: 16px; color: #e9fff3 }
    .row { display: flex; gap: 10px; flex-wrap: wrap }
    .row > * { flex: 1 }
    button, .btn {
      background: var(--accent);
      color: #08130e;
      border: none;
      padding: 10px 14px;
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.05s ease, box-shadow 0.15s ease;
      box-shadow: 0 6px 18px rgba(0, 230, 118, 0.18);
      white-space: nowrap;
    }
    button:hover, .btn:hover { transform: translateY(-1px) }
    button:disabled { opacity: 0.6; cursor: not-allowed }
    .btn-secondary {
      background: #1b2327; color: #d4e9dd; border: 1px solid var(--border); box-shadow: none;
    }
    .packs {
      display: grid; gap: 10px;
    }
    .pack {
      display: grid; grid-template-columns: 36px 1fr auto auto;
      align-items: center; gap: 10px; padding: 8px;
      border: 1px dashed var(--border); border-radius: 10px;
    }
    .pack .drag {
      width: 36px; height: 36px; display: grid; place-items: center;
      color: #7bb; background: #101618; border-radius: 8px; font-size: 18px;
    }
    .pack .meta { display: flex; flex-direction: column; gap: 2px }
    .pack .meta .name { color: #e6fff0; font-weight: 600; overflow-wrap: anywhere }
    .pack .meta .size { font-size: 12px; color: #a7b7af }
    .pack .role { margin-right: 8px }
    select, input[type="text"], input[type="number"], input[type="file"], textarea {
      width: 100%; background: #0e1416; color: #e5fff2; border: 1px solid var(--border);
      padding: 10px; border-radius: 10px; outline: none;
    }
    label { font-size: 12px; color: #a7b7af }
    .grid2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px }
    @media (max-width: 680px) { .grid2 { grid-template-columns: 1fr } }
    .divider { height: 1px; background: var(--border); margin: 10px 0 }
    .filemap { max-height: 320px; overflow: auto; border: 1px solid var(--border); border-radius: 10px; padding: 8px; background: #0b1012 }
    .file-row { display: grid; grid-template-columns: 1fr 200px; gap: 8px; align-items: center; padding: 6px 4px; border-bottom: 1px dashed #122026 }
    .file-row:last-child { border-bottom: none }
    .muted { color: #a7b7af }
    .progress-wrap {
      height: 10px; background: #0e1518; border: 1px solid var(--border); border-radius: 999px; overflow: hidden;
    }
    .progress { height: 100%; width: 0%; background: linear-gradient(90deg, var(--accent), var(--accent-dim)); transition: width 0.2s ease }
    .badge { font-size: 12px; color: #cde8de; background: #0e1b16; border: 1px solid #17362b; padding: 2px 6px; border-radius: 999px }
    .danger { background: var(--danger); color: #fff }
    .warn { background: var(--warn); color: #1b1300 }
    .pill { padding: 4px 8px; border-radius: 999px; font-size: 12px; border: 1px solid var(--border); background: #11181a; color: #d8efe4 }
    .footer { padding: 14px 20px; border-top: 1px solid var(--border); color: #8db39f; font-size: 12px }
    .modrinth-bar { display: flex; gap: 6px }
    .small { font-size: 12px }
    .hint { font-size: 12px; color: #9ab8ad }
  </style>
</head>
<body>
  <header>
    <div class="logo"></div>
    <div>
      <h1>OG Krish — Resource Pack Combiner</h1>
      <div class="hint">Combine multiple Minecraft resource packs, choose overrides, edit icon/name, and download a merged pack.</div>
    </div>
  </header>

  <main>
    <!-- Left: Packs & Modrinth -->
    <section class="card">
      <h2>Packs & sources</h2>
      <div class="row">
        <div>
          <label>Upload resource pack ZIPs (first becomes Base; re-order later)</label>
          <input id="fileInput" type="file" accept=".zip" multiple />
        </div>
        <div>
          <label>Quick actions</label>
          <div class="row">
            <button id="clearPacks" class="btn-secondary">Clear all</button>
            <button id="setFirstAsBase" class="btn-secondary">Set first as Base</button>
          </div>
        </div>
      </div>

      <div class="divider"></div>

      <div>
        <label>Modrinth search</label>
        <div class="modrinth-bar">
          <input id="modrinthQuery" type="text" placeholder="Search Modrinth resource packs..." />
          <button id="modrinthSearch">Search</button>
        </div>
        <div class="hint">Pick resource packs directly from Modrinth and add them to merge queue.</div>
        <div id="modrinthResults" class="filemap" style="margin-top:8px;"></div>
      </div>

      <div class="divider"></div>

      <h2>Order & roles</h2>
      <div class="hint">Drag using arrows, designate one Base, then Layer 1, Layer 2, etc. Higher layers override lower layers unless overridden per‑file below.</div>
      <div id="packList" class="packs"></div>
    </section>

    <!-- Right: Merge rules & Output -->
    <section class="card">
      <h2>Merge rules & output</h2>
      <div class="grid2">
        <div>
          <label>Merged pack name</label>
          <input id="mergedName" type="text" value="Merged Pack by OG Krish" />
        </div>
        <div>
          <label>Pack format (Java)</label>
          <input id="packFormat" type="number" min="1" step="1" value="18" />
          <div class="hint small">Use a valid pack_format for target version (e.g., 15 for 1.20.1, 18 for 1.20.2+).</div>
        </div>
      </div>
      <div class="grid2" style="margin-top:8px;">
        <div>
          <label>Pack icon (pack.png)</label>
          <input id="iconInput" type="file" accept="image/png" />
          <div class="hint small">If not set, a default icon will be generated.</div>
        </div>
        <div>
          <label>Description</label>
          <input id="descInput" type="text" value="merged by og krish's website" />
        </div>
      </div>

      <div class="divider"></div>

      <h2>Choose file sources</h2>
      <div class="hint">For each file in assets/ and top‑level pack.png or pack.mcmeta, choose which pack wins.</div>
      <div id="fileMap" class="filemap"></div>

      <div class="divider"></div>

      <div class="row">
        <button id="buildMap" class="btn-secondary">Scan & build file map</button>
        <button id="mergeBtn">Merge</button>
        <button id="downloadBtn" disabled>Download merged ZIP</button>
      </div>
      <div style="margin-top:10px">
        <div class="progress-wrap"><div id="progress" class="progress"></div></div>
        <div id="status" class="hint" style="margin-top:6px">Idle</div>
      </div>
    </section>
  </main>

  <div class="footer">
    Notes: A valid resource pack contains assets/, pack.mcmeta (with pack_format), and optionally pack.png as an icon. This tool preserves structure and lets higher layers override lower ones unless a specific source is chosen per file. Merging is done client‑side for privacy. 
  </div>

<script>
/*
  OG Krish Resource Pack Combiner
  — Client-side merging of Minecraft resource packs with per-file source selection.
  — Uses JSZip to read/write ZIPs in the browser.
  — Includes Modrinth search and direct add to queue.
*/

// Data structures
const state = {
  // Array of { id, name, size, zip: JSZip, files: Map<path, JSZipObject>, role: 'Base'|'Layer', layerIndex: number, source: 'upload'|'modrinth', slug? }
  packs: [],
  // fileMap: key = normalized path, value = { candidates: [{packId, path, size}], chosenPackId }
  fileMap: new Map(),
  // merged zip
  mergedZip: null,
};

// Utilities
const $ = (id) => document.getElementById(id);
const fmtSize = (n) => {
  if (n < 1024) return n + ' B';
  if (n < 1024*1024) return (n/1024).toFixed(1) + ' KB';
  return (n/1024/1024).toFixed(2) + ' MB';
};
const setStatus = (msg) => { $('status').textContent = msg; };
const setProgress = (pct) => { $('progress').style.width = Math.max(0, Math.min(100, pct)) + '%'; };

// Validate resource pack structure quick check
function isLikelyResourcePack(entries) {
  // Heuristic: has at least one of 'assets/' folder or 'pack.mcmeta'
  return entries.some(p => p === 'pack.mcmeta' || p.startsWith('assets/'));
}

// Read uploaded zips
$('fileInput').addEventListener('change', async (e) => {
  const files = Array.from(e.target.files || []);
  if (!files.length) return;

  setStatus('Loading ZIPs...');
  for (const file of files) {
    try {
      const buf = await file.arrayBuffer();
      const zip = await JSZip.loadAsync(buf);
      const entries = Object.keys(zip.files).map(k => k.replace(/^./?/,''));
      if (!isLikelyResourcePack(entries)) {
        console.warn('Skipped non-resource pack:', file.name);
        continue;
      }
      const id = crypto.randomUUID();
      const pack = {
        id,
        name: file.name.replace(/.zip$/i, ''),
        size: file.size,
        zip,
        files: new Map(Object.entries(zip.files)),
        role: state.packs.length === 0 ? 'Base' : 'Layer',
        layerIndex: state.packs.length === 0 ? 0 : state.packs.filter(p => p.role === 'Layer').length + 1,
        source: 'upload'
      };
      state.packs.push(pack);
    } catch (err) {
      console.error(err);
      alert('Failed to read ZIP: ' + file.name);
    }
  }
  renderPackList();
  setStatus('Loaded ' + state.packs.length + ' pack(s).');
  e.target.value = '';
});

// Pack list rendering
function renderPackList() {
  const list = $('packList');
  list.innerHTML = '';
  // Recalculate layer indices
  let layerCounter = 1;
  let baseSeen = false;
  for (const p of state.packs) {
    if (p.role === 'Base' && !baseSeen) { p.layerIndex = 0; baseSeen = true; }
  }
  for (const p of state.packs) {
    if (p.role === 'Layer') { p.layerIndex = layerCounter++; }
  }

  state.packs.forEach((p, idx) => {
    const row = document.createElement('div');
    row.className = 'pack';

    // Drag controls
    const drag = document.createElement('div');
    drag.className = 'drag';
    const up = document.createElement('button');
    up.className = 'btn-secondary'; up.textContent = '↑'; up.style.padding = '6px 8px';
    up.onclick = () => { if (idx > 0) { const t = state.packs[idx]; state.packs[idx] = state.packs[idx-1]; state.packs[idx-1] = t; renderPackList(); } };
    const down = document.createElement('button');
    down.className = 'btn-secondary'; down.textContent = '↓'; down.style.padding = '6px 8px';
    down.onclick = () => { if (idx < state.packs.length - 1) { const t = state.packs[idx]; state.packs[idx] = state.packs[idx+1]; state.packs[idx+1] = t; renderPackList(); } };
    drag.appendChild(up); drag.appendChild(down);

    // Meta
    const meta = document.createElement('div');
    meta.className = 'meta';
    const name = document.createElement('div');
    name.className = 'name';
    name.textContent = p.name + (p.source === 'modrinth' ? '  • Modrinth' : '');
    const size = document.createElement('div');
    size.className = 'size';
    size.textContent = fmtSize(p.size || 0);
    meta.appendChild(name); meta.appendChild(size);

    // Role selector
    const roleSel = document.createElement('select');
    roleSel.className = 'role';
    const optBase = document.createElement('option'); optBase.value = 'Base'; optBase.textContent = 'Base';
    const optLayer = document.createElement('option'); optLayer.value = 'Layer'; optLayer.textContent = 'Layer';
    roleSel.appendChild(optBase); roleSel.appendChild(optLayer);
    roleSel.value = p.role;
    roleSel.onchange = () => {
      // Ensure exactly one Base
      if (roleSel.value === 'Base') {
        state.packs.forEach(x => { x.role = x.id === p.id ? 'Base' : 'Layer'; });
      } else {
        // If none base remains, force first as Base
        p.role = 'Layer';
        if (!state.packs.some(x => x.role === 'Base')) {
          state.packs[0].role = 'Base';
        }
      }
      renderPackList();
    };

    // Layer badge
    const badge = document.createElement('span');
    badge.className = 'pill';
    badge.textContent = p.role === 'Base' ? 'Base' : ('Layer ' + p.layerIndex);

    // Remove
    const remove = document.createElement('button');
    remove.className = 'btn-secondary';
    remove.textContent = 'Remove';
    remove.onclick = () => {
      state.packs = state.packs.filter(x => x.id !== p.id);
      renderPackList();
    };

    row.appendChild(drag);
    row.appendChild(meta);
    row.appendChild(roleSel);
    row.appendChild(badge);
    row.appendChild(remove);
    list.appendChild(row);
  });
}

// Clear all
$('clearPacks').addEventListener('click', () => {
  state.packs = [];
  state.fileMap.clear();
  $('fileMap').innerHTML = '';
  renderPackList();
  setStatus('Cleared all packs.');
  setProgress(0);
  $('downloadBtn').disabled = true;
});

// Set first as Base
$('setFirstAsBase').addEventListener('click', () => {
  if (!state.packs.length) return;
  state.packs.forEach((p, i) => p.role = i === 0 ? 'Base' : 'Layer');
  renderPackList();
});

// Build file map
$('buildMap').addEventListener('click', async () => {
  if (!state.packs.length) { alert('Add at least one resource pack first.'); return; }
  setStatus('Scanning packs and building file map...');
  setProgress(5);

  const fileMap = new Map(); // path -> { candidates: [{packId, path, size}], chosenPackId }
  // Traverse in display order (top to bottom)
  for (const p of state.packs) {
    for (const [path, obj] of p.files) {
      const npath = path.replace(/^./?/,'');
      if (obj.dir) continue;
      // Only include pack files we care about: pack.png, pack.mcmeta, assets/**
      if (!(npath === 'pack.png' || npath === 'pack.mcmeta' || npath.startsWith('assets/'))) continue;
      if (!fileMap.has(npath)) fileMap.set(npath, { candidates: [], chosenPackId: null });
      fileMap.get(npath).candidates.push({ packId: p.id, path: npath, size: obj._data ? obj._data.uncompressedSize : (obj._dataInitial ? obj._dataInitial.length : 0) });
    }
  }

  // Default choice: highest layer wins unless base explicitly chosen, but user can override
  // We’ll compute a precedence index: Base = 0, Layer numbers ascending; highest index wins
  const precedence = new Map();
  for (const p of state.packs) precedence.set(p.id, p.role === 'Base' ? 0 : p.layerIndex);

  for (const [npath, rec] of fileMap.entries()) {
    let best = rec.candidates[0];
    for (const c of rec.candidates) {
      if (precedence.get(c.packId) > precedence.get(best.packId)) best = c;
    }
    rec.chosenPackId = best.packId;
  }

  state.fileMap = fileMap;
  renderFileMap();
  setProgress(15);
  setStatus('File map ready. Review and adjust sources if needed.');
});

// Render file map UI
function renderFileMap() {
  const container = $('fileMap');
  container.innerHTML = '';
  // Sort keys for stable UI: pack.mcmeta, pack.png, then assets
  const keys = Array.from(state.fileMap.keys()).sort((a, b) => {
    const rank = p => p === 'pack.mcmeta' ? 0 : p === 'pack.png' ? 1 : 2;
    const r = rank(a) - rank(b);
    return r !== 0 ? r : a.localeCompare(b);
  });

  for (const k of keys) {
    const rec = state.fileMap.get(k);
    const row = document.createElement('div');
    row.className = 'file-row';

    const left = document.createElement('div');
    left.textContent = k;

    const right = document.createElement('div');
    const sel = document.createElement('select');
    // Option: “Auto (by order)”
    const autoOpt = document.createElement('option');
    autoOpt.value = 'AUTO';
    autoOpt.textContent = 'Auto (by order)';
    sel.appendChild(autoOpt);

    // Options per candidate
    for (const c of rec.candidates) {
      const pack = state.packs.find(p => p.id === c.packId);
      const opt = document.createElement('option');
      opt.value = c.packId;
      opt.textContent = `${pack ? pack.name : 'Unknown'} — ${fmtSize(c.size || 0)}`;
      sel.appendChild(opt);
    }

    // Set selection: specific chosen or AUTO if matches precedence-best
    sel.value = rec.chosenPackId || 'AUTO';
    sel.onchange = () => {
      rec.chosenPackId = sel.value === 'AUTO' ? null : sel.value;
    };

    right.appendChild(sel);
    row.appendChild(left);
    row.appendChild(right);
    container.appendChild(row);
  }
}

// Modrinth integration
const MODRINTH_API = 'https://api.modrinth.com/v2'; // public API v2
// Search resource packs by query, filter project_type=resourcepack
$('modrinthSearch').addEventListener('click', async () => {
  const q = $('modrinthQuery').value.trim();
  if (!q) return;
  setStatus('Searching Modrinth...');
  const resultsEl = $('modrinthResults');
  resultsEl.innerHTML = 'Searching...';

  try {
    // v2 search endpoint with facets to ensure project_type:resourcepack
    const url = `${MODRINTH_API}/search?query=${encodeURIComponent(q)}&facets=${encodeURIComponent('[["project_type:resourcepack"]]')}`;
    const res = await fetch(url, { headers: { 'User-Agent': 'OG-Krish-RP-Combiner/1.0' } });
    if (!res.ok) throw new Error('Modrinth search failed');
    const data = await res.json();

    resultsEl.innerHTML = '';
    (data.hits || []).slice(0, 12).forEach(hit => {
      const row = document.createElement('div');
      row.className = 'file-row';
      const left = document.createElement('div');
      left.innerHTML = `${hit.title} <span class="badge">${hit.slug}</span>`;
      const right = document.createElement('div');
      const addBtn = document.createElement('button');
      addBtn.textContent = 'Add latest file';
      addBtn.onclick = () => addModrinthProject(hit.project_id || hit.projectId || hit.slug, hit.title);
      right.appendChild(addBtn);
      row.appendChild(left); row.appendChild(right);
      resultsEl.appendChild(row);
    });
    if (!resultsEl.innerHTML) resultsEl.textContent = 'No results.';
    setStatus('Modrinth search complete.');
  } catch (err) {
    console.error(err);
    resultsEl.innerHTML = '<span class="danger pill">Error searching Modrinth</span>';
    setStatus('Modrinth search error.');
  }
});

// Add Modrinth project’s latest compatible resource pack file
async function addModrinthProject(idOrSlug, titleFallback) {
  try {
    setStatus('Fetching Modrinth project versions...');
    // Get versions; pick first file (latest entry)
    const url = `${MODRINTH_API}/project/${encodeURIComponent(idOrSlug)}/version`;
    const res = await fetch(url, { headers: { 'User-Agent': 'OG-Krish-RP-Combiner/1.0' } });
    if (!res.ok) throw new Error('Failed to fetch project versions');
    const versions = await res.json();
    if (!versions.length) throw new Error('No versions found');

    // Choose latest version with a .zip file
    let chosenFile = null;
    let chosenVersion = null;
    for (const v of versions) {
      const fzip = (v.files || []).find(f => (f.filename || '').toLowerCase().endsWith('.zip'));
      if (fzip) { chosenFile = fzip; chosenVersion = v; break; }
    }
    if (!chosenFile) throw new Error('No ZIP file found in latest versions');

    setStatus('Downloading pack from Modrinth...');
    const fileRes = await fetch(chosenFile.url, { headers: { 'User-Agent': 'OG-Krish-RP-Combiner/1.0' } });
    if (!fileRes.ok) throw new Error('Download failed');
    const buf = await fileRes.arrayBuffer();

    const zip = await JSZip.loadAsync(buf);
    const entries = Object.keys(zip.files).map(k => k.replace(/^./?/,''));
    if (!isLikelyResourcePack(entries)) {
      alert('Downloaded file is not a valid resource pack.');
      return;
    }
    const id = crypto.randomUUID();
    const name = (titleFallback || idOrSlug) + ' (Modrinth)';
    const pack = {
      id,
      name,
      size: buf.byteLength,
      zip,
      files: new Map(Object.entries(zip.files)),
      role: state.packs.length === 0 ? 'Base' : 'Layer',
      layerIndex: state.packs.length === 0 ? 0 : state.packs.filter(p => p.role === 'Layer').length + 1,
      source: 'modrinth',
      slug: idOrSlug
    };
    state.packs.push(pack);
    renderPackList();
    setStatus('Added Modrinth pack: ' + name);
  } catch (err) {
    console.error(err);
    alert('Modrinth add failed: ' + err.message);
    setStatus('Modrinth add error.');
  }
}

// Merge process
$('mergeBtn').addEventListener('click', async () => {
  if (!state.packs.length) { alert('Add packs first.'); return; }
  if (state.packs.filter(p => p.role === 'Base').length !== 1) {
    alert('Exactly one Base pack must be selected.');
    return;
  }
  if (state.fileMap.size === 0) {
    const confirmScan = confirm('No file map found. Build now?');
    if (!confirmScan) return;
    $('buildMap').click();
    // Wait a tick
    await new Promise(r => setTimeout(r, 200));
    if (state.fileMap.size === 0) { alert('File map still empty.'); return; }
  }

  setStatus('Merging packs...');
  setProgress(20);
  const merged = new JSZip();

  // Create assets folder lazily
  const addFileFromPack = async (pack, path) => {
    const obj = pack.files.get(path);
    if (!obj) return;
    const data = await obj.async('uint8array');
    merged.file(path, data);
  };

  // Determine precedence function
  const precedence = new Map();
  for (const p of state.packs) precedence.set(p.id, p.role === 'Base' ? 0 : p.layerIndex);

  // Apply fileMap choices
  const entries = Array.from(state.fileMap.entries());
  const total = entries.length;
  let done = 0;

  for (const [path, rec] of entries) {
    let chosenId = rec.chosenPackId;
    if (!chosenId) {
      // Auto by precedence
      let best = rec.candidates[0];
      for (const c of rec.candidates) {
        if (precedence.get(c.packId) > precedence.get(best.packId)) best = c;
      }
      chosenId = best.packId;
    }
    const pack = state.packs.find(p => p.id === chosenId);
    if (pack) {
      await addFileFromPack(pack, path);
    }
    done++;
    setProgress(20 + Math.floor(70 * (done / Math.max(1, total))));
  }

  // Ensure pack.mcmeta based on inputs
  const desc = $('descInput').value || "merged by og krish's website";
  const name = $('mergedName').value || "Merged Pack by OG Krish";
  const packFormat = parseInt($('packFormat').value || '18', 10);

  // If no pack.mcmeta selected, write one
  if (!merged.file('pack.mcmeta')) {
    const mcmeta = {
      pack: {
        pack_format: packFormat,
        description: desc
      }
    };
    merged.file('pack.mcmeta', JSON.stringify(mcmeta, null, 2));
  } else {
    // Overwrite description/pack_format to ensure coherence
    try {
      const raw = await merged.file('pack.mcmeta').async('string');
      const obj = JSON.parse(raw);
      obj.pack = obj.pack || {};
      obj.pack.pack_format = packFormat;
      obj.pack.description = desc;
      merged.file('pack.mcmeta', JSON.stringify(obj, null, 2));
    } catch {
      const mcmeta = { pack: { pack_format: packFormat, description: desc } };
      merged.file('pack.mcmeta', JSON.stringify(mcmeta, null, 2));
    }
  }

  // Pack icon: uploaded or fallback
  const iconInput = $('iconInput');
  if (iconInput.files && iconInput.files[0]) {
    const buf = new Uint8Array(await iconInput.files[0].arrayBuffer());
    merged.file('pack.png', buf);
  } else if (!merged.file('pack.png')) {
    // Generate a small green placeholder PNG (1x1) as a minimal valid icon
    // Here we embed a 1x1 green PNG base64
    const b64 = 'iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR4nGNgYAAAAAMAASsJTYQAAAAASUVORK5CYII=';
    merged.file('pack.png', b64ToUint8Array(b64));
  }

  state.mergedZip = merged;

  // Export
  setStatus('Finalizing ZIP...');
  const blob = await merged.generateAsync({ type: 'blob', compression: 'DEFLATE', compressionOptions: { level: 6 } });
  // Enable download button with cached blob
  $('downloadBtn').disabled = false;
  $('downloadBtn').onclick = () => {
    const safe = name.replace(/[^w-.()[]s]/g, '_');
    saveAs(blob, `${safe || 'Merged_Pack'}.zip`);
  };

  setProgress(100);
  setStatus('Merge complete. Click Download merged ZIP.');
});

// Helper: base64 to Uint8Array
function b64ToUint8Array(b64) {
  const bin = atob(b64);
  const len = bin.length;
  const bytes = new Uint8Array(len);
  for (let i = 0; i < len; i++) bytes[i] = bin.charCodeAt(i);
  return bytes;
}

// Initialize
renderPackList();
setStatus('Idle. Add packs to begin.');
</script>
</body>
</html>
